#compdef gsta gstat gstal gstap gstp gstac gstd gstaa fstash stash_then_run run_then_apply_stash run_then_find_stash run_then_pop_stash gstapu gstacm

# Function to provide smart argument completion for git stash functions
function _git_stash_complete_args() {
  local cmd="$1"
  
  # Only provide argument completion if we're in a git repo and beyond the first argument
  if (( CURRENT > 1 )) && git rev-parse --git-dir &>/dev/null 2>&1; then
    case "$cmd" in
      gstap|gstd)
        # These functions take stash indices as arguments
        local -a stashes
        local stash_count=0
        
        # Get stash list and create completion entries
        while IFS= read -r line; do
          if [[ -n "$line" ]]; then
            local stash_info="${line#stash@\{}"
            stash_info="${stash_info%\}*}"
            local stash_desc="${line#*\} }"
            stashes+=("${stash_count}:${stash_desc}")
            ((stash_count++))
          fi
        done < <(git stash list 2>/dev/null)
        
        if (( ${#stashes[@]} > 0 )); then
          _describe 'stashes' stashes
          return 0
        fi
        ;;
      gstaa)
        # gstaa can take a search term - no specific completion needed
        return 1
        ;;
      stash_then_run|run_then_apply_stash|run_then_find_stash|run_then_pop_stash)
        # These take shell commands - no specific completion needed
        return 1
        ;;
    esac
  fi
  
  # No specific argument completion available
  return 1
}


# Main completion function
function _git_stash() {
  local -a git_commands
  git_commands=(
    'gsta:Stash with untracked files'
    'gstat:Stash tracked files only'
    'gstal:List all stashes with colors'
    'gstap:Pop stash by index'
    'gstp:Pop stash (apply and drop)'
    'gstac:Clear all stashes'
    'gstd:Drop stash by index'
    'gstaa:Browse and apply stashes'
    'fstash:Interactive stash manager'
    'stash_then_run:Stash, run command, apply'
    'run_then_apply_stash:Run command then apply stash'
    'run_then_find_stash:Run command then browse stashes'
    'run_then_pop_stash:Run command then pop stash'
    'gstapu:Stash, pull with rebase, apply'
    'gstacm:Stash, checkout main, pull, return, apply'
  )
  
  # If no arguments yet, show command descriptions for zh help system
  if (( CURRENT == 1 )); then
    _describe 'git stash commands' git_commands
  else
    # Try to provide smart argument completion
    local cmd="$words[1]"
    if ! _git_stash_complete_args "$cmd"; then
      # Fallback to showing commands if no specific completion available
      _describe 'git stash commands' git_commands
    fi
  fi
}

# Call the main function
# The #compdef directive automatically registers this function
