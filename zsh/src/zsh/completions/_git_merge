#compdef gm gma gmc gmff gmnf gmsq pullBranchThenMergeWithIt pullMasThenMergeWithIt gamc

# Load git completion cache system
autoload -Uz "${0:h}/_git_cache_system" 2>/dev/null || true

# Function to provide smart argument completion for git merge functions
function _git_merge_complete_args() {
  local cmd="$1"
  
  # Only provide argument completion if we're in a git repo and beyond the first argument
  if (( CURRENT > 1 )) && git rev-parse --git-dir &>/dev/null 2>&1; then
    case "$cmd" in
      gm|gmff|gmnf|pullBranchThenMergeWithIt|pullMasThenMergeWithIt)
        # These functions take branch names as arguments
        local -a branches descriptions
        local branch desc
        
        # Load cache system if available
        if (( $+functions[_git_comp_branches] )); then
          while IFS=':' read -r branch desc; do
            [[ -n "$branch" ]] || continue
            descriptions+=("$branch:$desc")
          done < <(_git_comp_branches 2>/dev/null)
          
          if (( ${#descriptions[@]} > 0 )); then
            _describe 'git branches' descriptions
            return 0
          fi
        fi
        
        # Fallback to basic branch completion
        local -a fallback_branches
        fallback_branches=($(git branch --format='%(refname:short)' 2>/dev/null))
        if (( ${#fallback_branches[@]} > 0 )); then
          _describe 'git branches' fallback_branches
          return 0
        fi
        ;;
      gmsq)
        # Squash merge requires a branch argument
        local -a branches descriptions
        local branch desc
        
        if (( $+functions[_git_comp_branches] )); then
          while IFS=':' read -r branch desc; do
            [[ -n "$branch" ]] || continue
            descriptions+=("$branch:$desc")
          done < <(_git_comp_branches 2>/dev/null)
          
          if (( ${#descriptions[@]} > 0 )); then
            _describe 'git branches' descriptions
            return 0
          fi
        fi
        
        local -a fallback_branches
        fallback_branches=($(git branch --format='%(refname:short)' 2>/dev/null))
        if (( ${#fallback_branches[@]} > 0 )); then
          _describe 'git branches' fallback_branches
          return 0
        fi
        ;;
      gamc)
        # Takes file paths as arguments - complete with git modified files
        local -a modified_files
        modified_files=($(git diff --name-only HEAD 2>/dev/null))
        
        if (( ${#modified_files[@]} > 0 )); then
          _describe 'modified files' modified_files
        fi
        
        # Also allow general file completion
        _files
        return 0
        ;;
    esac
  fi
  
  # No specific argument completion available
  return 1
}

# Main completion entry point
function _git_merge() {
  local -a git_commands
  git_commands=(
    'gm:Merge branch into current branch'
    'gma:Abort merge'
    'gmc:Continue merge'
    'gmff:Merge with fast-forward only'
    'gmnf:Merge with no fast-forward'
    'gmsq:Squash merge branch'
    'pullBranchThenMergeWithIt:Pull branch then merge'
    'pullMasThenMergeWithIt:Pull main then merge'
    'gamc:Add files and continue merge'
  )

  # If no arguments yet, show command descriptions
  if (( CURRENT == 1 )); then
    _describe 'git merge commands' git_commands
  else
    # Try to provide smart argument completion
    local cmd="$words[1]"
    if ! _git_merge_complete_args "$cmd"; then
      # Fallback to showing commands if no specific completion available
      _describe 'git merge commands' git_commands
    fi
  fi
}

# The #compdef directive at the top automatically registers this function
# No need to call it explicitly - zsh will call _git_merge when needed
