#compdef grb grbi grbc grba grbs pullBranchThenRebaseWithIt gm gma gmc pullBranchThenMergeWithIt grbo grbas gstarbm gstarb grbh gpmm gprm pullMasThenRebaseWithIt

# Load git completion cache system
autoload -Uz "${0:h}/_git_cache_system" 2>/dev/null || true

# Function to provide smart argument completion for git rebase functions
function _git_rebase_complete_args() {
  local cmd="$1"
  
  # Only provide argument completion if we're in a git repo and beyond the first argument
  if (( CURRENT > 1 )) && git rev-parse --git-dir &>/dev/null 2>&1; then
    case "$cmd" in
      grb|pullBranchThenRebaseWithIt|gm|gma|pullBranchThenMergeWithIt|gpmm|gprm|pullMasThenRebaseWithIt)
        # These functions take branch names as arguments
        local -a branches descriptions
        local branch desc
        
        # Load cache system if available
        if (( $+functions[_git_comp_branches] )); then
          while IFS=':' read -r branch desc; do
            [[ -n "$branch" ]] || continue
            descriptions+=("$branch:$desc")
          done < <(_git_comp_branches 2>/dev/null)
          
          if (( ${#descriptions[@]} > 0 )); then
            _describe 'git branches' descriptions
            return 0
          fi
        fi
        
# Register completions even if functions aren't loaded yet
compdef _git_rebase_complete grb grbi grbc grba grbs pullBranchThenRebaseWithIt gm gma gmc pullBranchThenMergeWithIt grbo grbas gstarbm gstarb grbh gpmm gprm pullMasThenRebaseWithIt 2>/dev/null

# Main completion function that handles both help and arguments
function _git_rebase_complete() {
  # If no arguments yet, show command descriptions for zh help system
  if (( CURRENT == 1 )); then
    local -a commands
    commands=(
      'grb:Rebase onto branch'
      'grbi:Interactive rebase'
      'grbc:Continue rebase'
      'grba:Abort rebase'
      'grbs:Skip rebase'
      'pullBranchThenRebaseWithIt:Pull branch then rebase'
      'gm:Merge branch'
      'gma:Abort merge'
      'gmc:Continue merge'
      'pullBranchThenMergeWithIt:Pull branch then merge'
      'grbo:Rebase onto (advanced)'
      'grbas:Rebase autosquash'
      'gstarbm:Stash and rebase main'
      'gstarb:Stash and rebase branch'
      'grbh:Interactive rebase HEAD'
      'gpmm:Pull main and rebase (alias)'
      'gprm:Pull main and rebase (alias)'
      'pullMasThenRebaseWithIt:Pull main then rebase (alias)'
    )
    _describe 'git rebase/merge commands' commands
  else
    # Try to provide smart argument completion
    local cmd="$words[1]"
    if ! _git_rebase_complete_args "$cmd"; then
      # Fallback to showing commands if no specific completion available
      local -a commands
      commands=(
        'grb:Rebase onto branch'
        'grbi:Interactive rebase'
        'grbc:Continue rebase'
        'grba:Abort rebase'
        'grbs:Skip rebase'
        'pullBranchThenRebaseWithIt:Pull branch then rebase'
        'gm:Merge branch'
        'gma:Abort merge'
        'gmc:Continue merge'
        'pullBranchThenMergeWithIt:Pull branch then merge'
        'grbo:Rebase onto (advanced)'
        'grbas:Rebase autosquash'
        'gstarbm:Stash and rebase main'
        'gstarb:Stash and rebase branch'
        'grbh:Interactive rebase HEAD'
        'gpmm:Pull main and rebase (alias)'
        'gprm:Pull main and rebase (alias)'
        'pullMasThenRebaseWithIt:Pull main then rebase (alias)'
      )
      _describe 'git rebase/merge commands' commands
    fi
  fi
}
        # Fallback to basic branch completion
        local -a fallback_branches
        fallback_branches=($(git branch --format='%(refname:short)' 2>/dev/null))
        if (( ${#fallback_branches[@]} > 0 )); then
          _describe 'git branches' fallback_branches
          return 0
        fi
        ;;
      grbi)
        # Interactive rebase - can take branch name or HEAD~N
        local -a options descriptions
        local branch desc
        
        # Add HEAD~N options
        options=(
          'HEAD~2:Last 2 commits'
          'HEAD~3:Last 3 commits'
          'HEAD~5:Last 5 commits'
          'HEAD~10:Last 10 commits'
        )
        
        # Add branch options
        if (( $+functions[_git_comp_branches] )); then
          while IFS=':' read -r branch desc; do
            [[ -n "$branch" ]] || continue
            options+=("$branch:$desc")
          done < <(_git_comp_branches 2>/dev/null)
        fi
        
        if (( ${#options[@]} > 0 )); then
          _describe 'rebase target' options
          return 0
        fi
        ;;
      grbo)
        # Rebase onto - takes two arguments: onto_branch source_branch
        local -a branch_names
        
        # Get branches - avoid the colon syntax that's causing corruption
        while IFS= read -r branch; do
          [[ -n "$branch" ]] || continue
          branch_names+=("$branch")
        done < <(git branch --format='%(refname:short)' 2>/dev/null)
        
        if (( CURRENT == 2 )); then
          # First argument: onto branch (all branches available)
          if (( ${#branch_names[@]} > 0 )); then
            _describe 'onto branch' branch_names
            return 0
          fi
        elif (( CURRENT == 3 )); then
          # Second argument: source branch (exclude the first argument)
          local first_arg="$words[2]"
          local -a filtered_branches
          
          for branch in "${branch_names[@]}"; do
            if [[ "$branch" != "$first_arg" ]]; then
              filtered_branches+=("$branch")
            fi
          done
          
          if (( ${#filtered_branches[@]} > 0 )); then
            _describe 'source branch' filtered_branches
            return 0
          fi
        fi
        ;;
    esac
  fi
  
  # No specific argument completion available
  return 1
}

# Main completion entry point (only runs when called by zsh completion system)
function _git_rebase() {
  local -a git_commands
  git_commands=(
    'grb:Rebase onto branch'
    'grbi:Interactive rebase'
    'grbc:Continue rebase'
    'grba:Abort rebase'
    'grbs:Skip rebase'
    'pullBranchThenRebaseWithIt:Pull branch then rebase'
    'gm:Merge branch'
    'gma:Abort merge'
    'gmc:Continue merge'
    'pullBranchThenMergeWithIt:Pull branch then merge'
    'grbo:Rebase onto (advanced)'
    'grbas:Rebase autosquash'
    'gstarbm:Stash and rebase main'
    'gstarb:Stash and rebase branch'
    'grbh:Interactive rebase HEAD'
    'gpmm:Pull main and rebase (alias)'
    'gprm:Pull main and rebase (alias)'
    'pullMasThenRebaseWithIt:Pull main then rebase (alias)'
  )

  # If no arguments yet, show command descriptions for zh help system
  if (( CURRENT == 1 )); then
    _describe 'git rebase/merge commands' git_commands
  else
    # Try to provide smart argument completion
    local cmd="$words[1]"
    if ! _git_rebase_complete_args "$cmd"; then
      # Fallback to showing commands if no specific completion available
      _describe 'git rebase/merge commands' git_commands
    fi
  fi
}

# The #compdef directive at the top automatically registers this function
# No need to call it explicitly - zsh will call _git_rebase when needed