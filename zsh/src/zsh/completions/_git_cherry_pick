#compdef gcp gcpn gcpx gcpc gcpa gcps gcpq fcpick fcpicklog gcprange gcplast

# Function to provide smart argument completion for git cherry-pick functions
function _git_cherry_pick_complete_args() {
  local cmd="$1"
  
  # Only provide argument completion if we're in a git repo and beyond the first argument
  if (( CURRENT > 1 )) && git rev-parse --git-dir &>/dev/null 2>&1; then
    case "$cmd" in
      gcp|gcpn|gcpx)
        # These commands take commit hashes - complete with recent commits
        local -a recent_commits
        while IFS= read -r line; do
          if [[ -n "$line" ]]; then
            local hash="${line%% *}"
            local message="${line#* }"
            recent_commits+=("${hash}:${message}")
          fi
        done < <(git log --oneline -20 2>/dev/null)
        
        if (( ${#recent_commits[@]} > 0 )); then
          _describe 'recent commits' recent_commits
          return 0
        fi
        ;;
      fcpick|gcplast)
        # These can take branch names as arguments
        if (( CURRENT == 2 )); then
          local -a branches
          while IFS= read -r branch; do
            [[ -n "$branch" ]] || continue
            branches+=("$branch")
          done < <(git branch --format='%(refname:short)' 2>/dev/null)
          
          if (( ${#branches[@]} > 0 )); then
            _describe 'git branches' branches
            return 0
          fi
        fi
        ;;
      gcprange)
        # gcprange <start> <end> - complete with commit hashes for both
        if (( CURRENT == 2 || CURRENT == 3 )); then
          local -a recent_commits
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              local hash="${line%% *}"
              local message="${line#* }"
              recent_commits+=("${hash}:${message}")
            fi
          done < <(git log --oneline -20 2>/dev/null)
          
          if (( ${#recent_commits[@]} > 0 )); then
            _describe 'commits' recent_commits
            return 0
          fi
        fi
        ;;
    esac
  fi
  
  # No specific argument completion available
  return 1
}


# Main completion function
function _git_cherry_pick() {
  local -a git_commands
  git_commands=(
    'gcp:Cherry-pick commit(s)'
    'gcpn:Cherry-pick without commit'
    'gcpx:Cherry-pick with -x flag'
    'gcpc:Continue cherry-pick'
    'gcpa:Abort cherry-pick'
    'gcps:Skip current cherry-pick'
    'gcpq:Quit cherry-pick'
    'fcpick:Interactive cherry-pick browser'
    'fcpicklog:Cherry-pick from commit log'
    'gcprange:Cherry-pick range of commits'
    'gcplast:Cherry-pick last N commits'
  )
  
  # If no arguments yet, show command descriptions for zh help system
  if (( CURRENT == 1 )); then
    _describe 'git cherry-pick commands' git_commands
  else
    # Try to provide smart argument completion
    local cmd="$words[1]"
    if ! _git_cherry_pick_complete_args "$cmd"; then
      # Fallback to showing commands if no specific completion available
      _describe 'git cherry-pick commands' git_commands
    fi
  fi
}

# Call the main function
# The #compdef directive automatically registers this function
