#!/usr/bin/env zsh

set -e

# ZSH packages managed as git subtrees
declare -A ZSH_PACKAGES=(
    ["fast-syntax-highlight"]="https://github.com/zdharma-continuum/fast-syntax-highlighting.git master"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions.git master"
    ["zsh-autocomplete"]="https://github.com/marlonrichert/zsh-autocomplete.git main"
    ["zsh-you-should-use"]="https://github.com/MichaelAquilina/zsh-you-should-use.git master"
    ["zsh-defer"]="https://github.com/romkatv/zsh-defer.git master"
    ["zshmarks"]="https://github.com/jocelynmallon/zshmarks.git master"
)

# Must be run from dotfiles root
if [[ ! -d "zsh/src/zsh/tools" ]]; then
    echo "Error: Must be run from dotfiles root directory"
    exit 1
fi

TOOLS_PREFIX="zsh/src/zsh/tools"

add_subtree() {
    local name="$1"
    local repo_url="${ZSH_PACKAGES[$name]% *}"
    local branch="${ZSH_PACKAGES[$name]##* }"
    
    echo "Adding subtree: $name"
    git subtree add --prefix="$TOOLS_PREFIX/$name" "$repo_url" "$branch" --squash
}

update_subtree() {
    local name="$1"
    local repo_url="${ZSH_PACKAGES[$name]% *}"
    local branch="${ZSH_PACKAGES[$name]##* }"
    
    echo "Updating subtree: $name"
    git subtree pull --prefix="$TOOLS_PREFIX/$name" "$repo_url" "$branch" --squash
}

case "${1:-}" in
    init)
        echo "Initializing zsh tool subtrees..."
        for package in "${(@k)ZSH_PACKAGES}"; do
            if [[ ! -d "$TOOLS_PREFIX/$package" ]]; then
                add_subtree "$package"
            else
                echo "Skipping $package (already exists)"
            fi
        done
        ;;
    update)
        echo "Updating zsh tool subtrees..."
        for package in "${(@k)ZSH_PACKAGES}"; do
            if [[ -d "$TOOLS_PREFIX/$package" ]]; then
                update_subtree "$package"
            else
                echo "Adding missing subtree: $package"
                add_subtree "$package"
            fi
        done
        
        # Squash all updates into single commit
        if git diff --cached --quiet; then
            echo "No changes to commit"
        else
            git commit -m "Update zsh dependencies"
        fi
        ;;
    *)
        echo "Usage: $0 {init|update}"
        echo "  init   - Add git subtrees for all zsh tools"
        echo "  update - Update all subtrees and commit changes"
        exit 1
        ;;
esac